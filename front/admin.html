<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BUY LK — Admin Panel</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .admin-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 40px;
        background: var(--surface);
        border-radius: 24px;
        box-shadow: var(--shadow);
      }

      .admin-header {
        margin-bottom: 32px;
      }

      .admin-header h2 {
        font-size: 2rem;
        margin-bottom: 8px;
      }

      .admin-header p {
        color: var(--muted);
      }

      .admin-form {
        display: grid;
        gap: 16px;
      }

      .form-group {
        display: grid;
        gap: 8px;
      }

      .form-group label {
        font-weight: 600;
        font-size: 0.95rem;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: transparent;
        color: var(--text);
        font-size: 1rem;
        transition: border 0.2s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--primary);
      }

      .form-group input::placeholder,
      .form-group textarea::placeholder {
        color: var(--muted);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .admin-form button {
        padding: 12px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
      }

      .error-message {
        color: #ef4444;
        font-size: 0.9rem;
        padding: 8px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 8px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .success-message {
        color: #10b981;
        font-size: 0.9rem;
        padding: 8px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 8px;
        display: none;
      }

      .success-message.show {
        display: block;
      }

      .product-list {
        margin-top: 48px;
        padding-top: 32px;
        border-top: 1px solid var(--border);
      }

      .product-list h3 {
        font-size: 1.5rem;
        margin-bottom: 16px;
      }

      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
      }

      .product-card {
        padding: 16px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--bg);
        display: flex;
        flex-direction: column;
      }

      .product-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .product-card h4 {
        margin: 0 0 8px 0;
        font-size: 1rem;
      }

      .product-card p {
        margin: 4px 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .product-price {
        font-weight: 600;
        color: var(--primary);
        font-size: 1.1rem;
      }

      .product-actions-admin {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border);
      }

      .product-actions-admin button {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: background 0.2s;
      }

      .edit-btn {
        background: var(--primary);
        color: white;
      }

      .edit-btn:hover {
        background: #1e40af;
      }

      .delete-btn {
        background: #ef4444;
        color: white;
      }

      .delete-btn:hover {
        background: #dc2626;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: var(--surface);
        padding: 32px;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow);
      }

      .modal-header {
        margin-bottom: 24px;
      }

      .modal-header h3 {
        margin-bottom: 8px;
        font-size: 1.5rem;
      }

      .modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--muted);
      }

      .messages-section {
        margin-top: 48px;
        padding-top: 32px;
        border-top: 1px solid var(--border);
      }

      .messages-section h3 {
        font-size: 1.5rem;
        margin-bottom: 16px;
      }

      .messages-list {
        display: grid;
        gap: 16px;
      }

      .message-card {
        padding: 20px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--bg);
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
      }

      .message-info h4 {
        margin: 0 0 4px 0;
        font-size: 1rem;
      }

      .message-info p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .message-date {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .message-subject {
        font-weight: 600;
        margin: 8px 0;
        color: var(--text);
      }

      .message-content {
        color: var(--text);
        line-height: 1.6;
        margin-bottom: 12px;
      }

      .message-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      .message-actions button {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .reply-btn {
        background: var(--primary);
        color: white;
      }

      .reply-btn:hover {
        background: #1e40af;
      }

      .delete-message-btn {
        background: #ef4444;
        color: white;
      }

      .delete-message-btn:hover {
        background: #dc2626;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 2px solid var(--border);
      }

      .tab {
        padding: 12px 24px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: var(--muted);
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }

      .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .tab:hover {
        color: var(--text);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 24px;
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .search-box {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }

      .search-box input {
        flex: 1;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: transparent;
        color: var(--text);
        font-size: 1rem;
      }

      .search-box input:focus {
        outline: none;
        border-color: var(--primary);
      }

      .search-box input::placeholder {
        color: var(--muted);
      }

      .search-box button {
        padding: 12px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
      }

      .search-box button:hover {
        background: #1e40af;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <span class="logo">BL</span>
          <div>
            <h1>BUY LK</h1>
            <p>Premium picks for everyday life</p>
          </div>
        </div>
        <nav class="nav">
          <a href="../front/index.html">Home</a>
          <a href="admin.html">Admin</a>
          <a href="#" id="logoutLink" style="color: #ef4444;">Logout</a>
        </nav>
      </header>

      <div class="admin-container">
        <a href="../front/index.html" class="back-link">← Back to Shop</a>

        <div class="admin-header">
          <h2>Admin Panel</h2>
          <p>Add and manage products</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" data-tab="products">Products</button>
          <button class="tab" data-tab="messages">Contact Messages</button>
        </div>

        <!-- Products Tab -->
        <div class="tab-content active" id="products-tab">
        <div id="errorMsg" class="error-message"></div>
        <div id="successMsg" class="success-message"></div>

        <form class="admin-form" id="productForm">
          <div class="form-group">
            <label for="productName">Product Name *</label>
            <input
              type="text"
              id="productName"
              name="productName"
              placeholder="e.g., Aurora Smart Speaker"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="category">Category *</label>
              <select id="category" name="category" required>
                <option value="">Select category</option>
                <option value="tech">Tech</option>
                <option value="home">Home</option>
                <option value="fitness">Fitness</option>
                <option value="fashion">Fashion</option>
              </select>
            </div>

            <div class="form-group">
              <label for="price">Price ($) *</label>
              <input
                type="number"
                id="price"
                name="price"
                placeholder="0.00"
                min="0.01"
                step="0.01"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="rating">Rating (0-5)</label>
              <input
                type="number"
                id="rating"
                name="rating"
                placeholder="4.5"
                min="0"
                max="5"
                step="0.1"
                value="4.5"
              />
            </div>

            <div class="form-group">
              <label for="tag">Tag</label>
              <input
                type="text"
                id="tag"
                name="tag"
                placeholder="e.g., Bestseller, New, Eco"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="stock">Stock Count</label>
            <input
              type="number"
              id="stock"
              name="stock"
              placeholder="50"
              min="0"
              value="50"
            />
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea
              id="description"
              name="description"
              placeholder="Product description"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="image">Image URL</label>
            <input
              type="url"
              id="image"
              name="image"
              placeholder="https://example.com/image.jpg"
            />
          </div>

          <button type="submit" class="primary-btn">Add Product</button>
        </form>

        <div class="product-list">
          <h3>Current Products</h3>
          <div class="search-box">
            <input 
              type="text" 
              id="searchProducts" 
              placeholder="Search products by name or category..." 
            />
            <button id="clearSearch" type="button">Clear</button>
          </div>
          <div class="products-grid" id="productsGrid">
            <p>Loading products...</p>
          </div>
        </div>
        </div>
        <!-- End Products Tab -->

        <!-- Messages Tab -->
        <div class="tab-content" id="messages-tab">
          <div class="messages-section">
            <h3>Contact Messages</h3>
            <div class="search-box">
              <input 
                type="text" 
                id="searchMessages" 
                placeholder="Search messages by name or email..." 
              />
              <button id="clearMessagesSearch" type="button">Clear</button>
            </div>
            <div class="messages-list" id="messagesList">
              <p>Loading messages...</p>
            </div>
          </div>
        </div>
        <!-- End Messages Tab -->

      </div>

      <footer class="footer">
        <p>© 2026 BUY LK. Crafted for modern shoppers.</p>
        <div class="footer-links">
          <a href="#">Privacy</a>
          <a href="#">Terms</a>
          <a href="#">Support</a>
        </div>
      </footer>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <button class="modal-close" id="modalClose">&times;</button>
        <div class="modal-header">
          <h3>Edit Product</h3>
        </div>
        <form id="editForm" class="admin-form">
          <div class="form-group">
            <label for="editProductName">Product Name</label>
            <input type="text" id="editProductName" required />
          </div>
          <div class="form-group">
            <label for="editCategory">Category</label>
            <select id="editCategory" required>
              <option value="">Select category</option>
              <option value="tech">Tech</option>
              <option value="home">Home</option>
              <option value="fashion">Fashion</option>
              <option value="fitness">Fitness</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="editPrice">Price</label>
              <input type="number" id="editPrice" step="0.01" min="0" required />
            </div>
            <div class="form-group">
              <label for="editRating">Rating</label>
              <input type="number" id="editRating" step="0.1" min="0" max="5" />
            </div>
          </div>
          <div class="form-group">
            <label for="editDescription">Description</label>
            <textarea id="editDescription"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="editTag">Tag</label>
              <input type="text" id="editTag" />
            </div>
            <div class="form-group">
              <label for="editStock">Stock</label>
              <input type="number" id="editStock" min="0" />
            </div>
          </div>
          <div class="form-group">
            <label for="editImage">Image URL</label>
            <input type="url" id="editImage" />
          </div>
          <button type="submit" class="primary-btn" style="width: 100%;">Update Product</button>
        </form>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="../front/api.js"></script>
    <script>
      let editingProductId = null;
      // Check admin session on page load
      window.addEventListener('load', () => {
        const adminSession = localStorage.getItem('adminSession');
        if (!adminSession) {
          window.location.href = 'admin-login.html';
          return;
        }
        loadProducts();
      });

      // Logout handler
      document.getElementById('logoutLink').addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('adminSession');
        window.location.href = 'admin-login.html';
      });

      const getAdminSession = () => {
        const session = localStorage.getItem('adminSession');
        return session ? JSON.parse(session) : null;
      };

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          
          // Update active tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Update active content
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          document.getElementById(`${tabName}-tab`).classList.add('active');
          
          // Load messages when switching to messages tab
          if (tabName === 'messages') {
            loadMessages();
          }
        });
      });

      const productForm = document.getElementById("productForm");
      const errorMsg = document.getElementById("errorMsg");
      const successMsg = document.getElementById("successMsg");
      const productsGrid = document.getElementById("productsGrid");
      const searchInput = document.getElementById("searchProducts");
      const clearSearchBtn = document.getElementById("clearSearch");
      const messagesList = document.getElementById("messagesList");
      const searchMessagesInput = document.getElementById("searchMessages");
      const clearMessagesSearchBtn = document.getElementById("clearMessagesSearch");
      let allProducts = [];
      let allMessages = [];

      const showToast = (message) => {
        const toast = document.getElementById("toast");
        if (!toast) return;
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2400);
      };

      const searchProducts = (query) => {
        const filtered = allProducts.filter(product => {
          const searchTerm = query.toLowerCase();
          return (
            product.name.toLowerCase().includes(searchTerm) ||
            product.category.toLowerCase().includes(searchTerm) ||
            (product.tag && product.tag.toLowerCase().includes(searchTerm))
          );
        });
        renderProducts(filtered);
      };

      const renderProducts = (productsToRender) => {
        if (productsToRender.length === 0) {
          productsGrid.innerHTML = '<p>No products found.</p>';
          return;
        }

        productsGrid.innerHTML = productsToRender
          .map(
            (product) => `
            <div class="product-card">
              ${product.image ? `<img src="${product.image}" alt="${product.name}" />` : '<div style="width: 100%; height: 150px; background: var(--border); border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: var(--muted);">No image</div>'}
              <h4>${product.name}</h4>
              <p><strong>Category:</strong> ${product.category}</p>
              <p class="product-price">$${parseFloat(product.price).toFixed(2)}</p>
              <p><strong>Rating:</strong> ★ ${product.rating}</p>
              <p><strong>Stock:</strong> ${product.stock}</p>
              ${product.tag ? `<p><strong>Tag:</strong> ${product.tag}</p>` : ""}
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="available-${product.id}" ${product.is_available == 1 ? 'checked' : ''} class="availability-toggle" data-product-id="${product.id}" />
                <label for="available-${product.id}" style="margin: 0; cursor: pointer;">In Stock</label>
              </div>
              <div class="product-actions-admin">
                <button class="edit-btn" data-edit-id="${product.id}">Edit</button>
                <button class="delete-btn" data-delete-id="${product.id}">Delete</button>
              </div>
            </div>
          `
          )
          .join("");

        // Add event listeners for availability toggles
        document.querySelectorAll('.availability-toggle').forEach(toggle => {
          toggle.addEventListener('change', async (e) => {
            const productId = e.target.dataset.productId;
            const isAvailable = e.target.checked;
            await updateProductAvailability(productId, isAvailable);
          });
        });

        // Add event listeners for edit buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const productId = btn.dataset.editId;
            const product = allProducts.find(p => p.id == productId);
            if (product) openEditModal(product);
          });
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            if (confirm('Are you sure you want to delete this product?')) {
              await deleteProduct(btn.dataset.deleteId);
            }
          });
        });
      };

      const loadProducts = async () => {
        try {
          const response = await fetch(
            "http://localhost/New%20folder/backend/products/list.php"
          );
          const result = await response.json();

          if (Array.isArray(result) && result.length > 0) {
            allProducts = result;
            renderProducts(result);
          } else {
            productsGrid.innerHTML = "<p>No products yet. Add your first product!</p>";
          }
        } catch (error) {
          console.error("Error loading products:", error);
          productsGrid.innerHTML = "<p>Error loading products</p>";
        }
      };

      const updateProductAvailability = async (productId, isAvailable) => {
        try {
          const adminSession = getAdminSession();
          if (!adminSession) {
            showToast("Admin session expired. Please login again.");
            window.location.href = 'admin-login.html';
            return;
          }

          const response = await fetch(
            "http://localhost/New%20folder/backend/products/list.php",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                adminToken: adminSession.token,
                productId: parseInt(productId),
                is_available: isAvailable
              })
            }
          );

          const result = await response.json();
          if (result.success) {
            showToast(isAvailable ? "Product marked as In Stock" : "Product marked as Out of Stock");
          } else {
            showToast("Error updating availability: " + result.message);
          }
        } catch (error) {
          console.error("Error updating availability:", error);
          showToast("Error updating availability");
        }
      };

      const openEditModal = (product) => {
        editingProductId = product.id;
        document.getElementById('editProductName').value = product.name;
        document.getElementById('editCategory').value = product.category;
        document.getElementById('editPrice').value = parseFloat(product.price);
        document.getElementById('editRating').value = parseFloat(product.rating);
        document.getElementById('editDescription').value = product.description || '';
        document.getElementById('editTag').value = product.tag || '';
        document.getElementById('editStock').value = product.stock;
        document.getElementById('editImage').value = product.image || '';
        
        document.getElementById('editModal').classList.add('show');
      };

      const closeEditModal = () => {
        document.getElementById('editModal').classList.remove('show');
        editingProductId = null;
      };

      const deleteProduct = async (productId) => {
        try {
          const adminSession = getAdminSession();
          if (!adminSession) {
            showToast("Admin session expired. Please login again.");
            window.location.href = 'admin-login.html';
            return;
          }

          const response = await fetch(
            "http://localhost/New%20folder/backend/products/list.php",
            {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                adminToken: adminSession.token,
                id: parseInt(productId)
              })
            }
          );

          const result = await response.json();
          if (result.success) {
            showToast("Product deleted successfully");
            loadProducts();
          } else {
            showToast("Error deleting product: " + result.message);
          }
        } catch (error) {
          console.error("Error deleting product:", error);
          showToast("Error deleting product");
        }
      };

      // Modal event listeners
      document.getElementById('modalClose').addEventListener('click', closeEditModal);
      document.getElementById('editModal').addEventListener('click', (e) => {
        if (e.target.id === 'editModal') closeEditModal();
      });

      document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const adminSession = getAdminSession();
        if (!adminSession) {
          showToast("Admin session expired. Please login again.");
          window.location.href = 'admin-login.html';
          return;
        }

        const productData = {
          adminToken: adminSession.token,
          id: editingProductId,
          name: document.getElementById('editProductName').value.trim(),
          category: document.getElementById('editCategory').value.trim(),
          price: parseFloat(document.getElementById('editPrice').value),
          rating: parseFloat(document.getElementById('editRating').value) || 4.5,
          description: document.getElementById('editDescription').value.trim(),
          tag: document.getElementById('editTag').value.trim(),
          stock: parseInt(document.getElementById('editStock').value) || 50,
          image: document.getElementById('editImage').value.trim()
        };

        if (!productData.name || !productData.category || productData.price <= 0) {
          showToast("Product name, category, and valid price are required");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/New%20folder/backend/products/list.php",
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(productData)
            }
          );

          const result = await response.json();
          if (result.success) {
            showToast("Product updated successfully");
            closeEditModal();
            loadProducts();
          } else {
            showToast("Error: " + result.message);
          }
        } catch (error) {
          console.error("Error updating product:", error);
          showToast("Error updating product");
        }
      });

      productForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const adminSession = getAdminSession();
        if (!adminSession) {
          errorMsg.textContent = "Admin session expired. Please login again.";
          errorMsg.classList.add("show");
          setTimeout(() => {
            window.location.href = 'admin-login.html';
          }, 1500);
          return;
        }

        const productName = document.getElementById("productName").value.trim();
        const category = document.getElementById("category").value.trim();
        const price = parseFloat(document.getElementById("price").value);
        const rating = parseFloat(document.getElementById("rating").value) || 4.5;
        const tag = document.getElementById("tag").value.trim();
        const stock = parseInt(document.getElementById("stock").value) || 50;
        const description = document.getElementById("description").value.trim();
        const image = document.getElementById("image").value.trim();

        if (!productName || !category || !price) {
          errorMsg.textContent = "Product name, category, and price are required";
          errorMsg.classList.add("show");
          return;
        }

        if (price <= 0) {
          errorMsg.textContent = "Price must be greater than 0";
          errorMsg.classList.add("show");
          return;
        }

        errorMsg.classList.remove("show");
        successMsg.classList.remove("show");

        const submitBtn = productForm.querySelector("button");
        const originalText = submitBtn.textContent;
        submitBtn.textContent = "Adding...";
        submitBtn.disabled = true;

        try {
          const response = await fetch(
            "http://localhost/New%20folder/backend/products/list.php",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                adminToken: adminSession.token,
                name: productName,
                category,
                price,
                rating,
                tag,
                stock,
                description,
                image,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            successMsg.textContent = "Product added successfully!";
            successMsg.classList.add("show");
            showToast("Product added!");
            productForm.reset();
            document.getElementById("rating").value = "4.5";
            document.getElementById("stock").value = "50";
            loadProducts();
          } else {
            errorMsg.textContent = result.message || "Failed to add product";
            errorMsg.classList.add("show");
          }
        } catch (error) {
          console.error("Error:", error);
          errorMsg.textContent = "An error occurred. Please try again.";
          errorMsg.classList.add("show");
        } finally {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      });

      // Load products on page load
      loadProducts();

      // Messages functionality
      const loadMessages = async () => {
        try {
          const response = await fetch(
            "http://localhost/New%20folder/backend/contact/messages.php"
          );
          const result = await response.json();

          if (Array.isArray(result) && result.length > 0) {
            allMessages = result;
            renderMessages(result);
          } else {
            messagesList.innerHTML = "<p>No messages yet.</p>";
          }
        } catch (error) {
          console.error("Error loading messages:", error);
          messagesList.innerHTML = "<p>Error loading messages</p>";
        }
      };

      const renderMessages = (messagesToRender) => {
        if (messagesToRender.length === 0) {
          messagesList.innerHTML = '<p>No messages found.</p>';
          return;
        }

        messagesList.innerHTML = messagesToRender
          .map(
            (message) => `
            <div class="message-card">
              <div class="message-header">
                <div class="message-info">
                  <h4>${message.name}</h4>
                  <p>${message.email}</p>
                </div>
                <span class="message-date">${new Date(message.created_at).toLocaleDateString('en-US', { 
                  year: 'numeric', 
                  month: 'short', 
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                })}</span>
              </div>
              <div class="message-subject"><strong>Subject:</strong> ${message.subject || 'No subject'}</div>
              <div class="message-content">${message.message}</div>
              <div class="message-actions">
                <button class="reply-btn" onclick="window.location.href='mailto:${message.email}?subject=Re: ${encodeURIComponent(message.subject || 'Your message')}'">Reply</button>
                <button class="delete-message-btn" data-message-id="${message.id}">Delete</button>
              </div>
            </div>
          `
          )
          .join("");

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-message-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this message?')) {
              await deleteMessage(btn.dataset.messageId);
            }
          });
        });
      };

      const searchMessages = (query) => {
        const filtered = allMessages.filter(message => {
          const searchTerm = query.toLowerCase();
          return (
            message.name.toLowerCase().includes(searchTerm) ||
            message.email.toLowerCase().includes(searchTerm) ||
            (message.subject && message.subject.toLowerCase().includes(searchTerm)) ||
            message.message.toLowerCase().includes(searchTerm)
          );
        });
        renderMessages(filtered);
      };

      const deleteMessage = async (messageId) => {
        try {
          const adminSession = getAdminSession();
          if (!adminSession) {
            showToast("Admin session expired. Please login again.");
            window.location.href = 'admin-login.html';
            return;
          }

          const response = await fetch(
            "http://localhost/New%20folder/backend/contact/messages.php",
            {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                adminToken: adminSession.token,
                id: parseInt(messageId)
              })
            }
          );

          const result = await response.json();
          if (result.success) {
            showToast("Message deleted successfully");
            loadMessages();
          } else {
            showToast("Error deleting message: " + result.message);
          }
        } catch (error) {
          console.error("Error deleting message:", error);
          showToast("Error deleting message");
        }
      };

      // Search functionality
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (query) {
          searchProducts(query);
        } else {
          renderProducts(allProducts);
        }
      });

      clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        renderProducts(allProducts);
      });

      // Messages search functionality
      searchMessagesInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (query) {
          searchMessages(query);
        } else {
          renderMessages(allMessages);
        }
      });

      clearMessagesSearchBtn.addEventListener('click', () => {
        searchMessagesInput.value = '';
        renderMessages(allMessages);
      });

      // Set theme
      const theme = localStorage.getItem("theme") || "light";
      document.documentElement.dataset.theme = theme;
    </script>
  </body>
</html>
